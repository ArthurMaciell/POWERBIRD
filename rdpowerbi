import requests
import pandas as pd
from datetime import datetime, timedelta, timezone

# Dados da aplicação
client_id = "6cfe7ad0-3030-4a22-b2e5-044907a997e0"
client_secret = "881083e28ccb47c8b07eae310e61722f"

#Obter token
def obter_token(client_id, client_secret):
    response = requests.post(
        "https://api.rd.services/auth/token",
        json={"client_id": client_id, "client_secret": client_secret}
    )
    return response.json()["access_token"]


def buscar_deals_ganhos(token):
    seis_meses_atras = (datetime.now(timezone.utc) - timedelta(days=180)).strftime("%Y-%m-%dT%H:%M:%SZ")
    url = f"https://crm.rdstation.com/api/v1/deals?won=true&created_at_start={seis_meses_atras}&page=1&limit=100"
    headers = {"Authorization": f"Bearer {token}"}
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        return response.json()["deals"]
    else:
        print("Erro:", response.status_code, response.text)
        return []

# Execução
token = obter_token(client_id, client_secret)
deals = buscar_deals_ganhos(token)
df = pd.json_normalize(deals)
df.to_csv("negociacoes_ganhas.csv", index=False)
print("Arquivo 'negociacoes_ganhas.csv' gerado com sucesso.")